[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Multiple Cheque Entry",
  "enabled": 0,
  "modified": "2025-09-01 23:50:47.104567",
  "module": "ECS Cheques",
  "name": "Multiple Cheque Entry ECS Cheques",
  "script": "frappe.ui.form.on('Multiple Cheque Entry', {\r\n    // Triggered when the form is refreshed\r\n    refresh: function(frm) {\r\n        // Set up initial values for all rows\r\n        frm.doc.cheque_table.forEach(row => {\r\n            if (row.party) {\r\n                set_party_details(frm, row);\r\n            }\r\n            if (row.mode_of_payment) {\r\n                set_default_account(frm, row);\r\n            }\r\n            if (row.account_paid_to && row.account_paid_from && row.reference_date) {\r\n                update_exchange_rate(frm, row);\r\n            }\r\n        });\r\n    },\r\n    \r\n    // Triggered before saving\r\n    before_save: function(frm) {\r\n        // Ensure all rows have proper values before saving\r\n        frm.doc.cheque_table.forEach(row => {\r\n            if (row.party && !row.issuer_name) {\r\n                set_party_details(frm, row);\r\n            }\r\n            if (row.mode_of_payment && !row.account_paid_to) {\r\n                set_default_account(frm, row);\r\n            }\r\n            if (row.account_paid_to && row.account_paid_from && row.reference_date && !row.target_exchange_rate) {\r\n                update_exchange_rate(frm, row);\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n// Handle child table events\r\nfrappe.ui.form.on('Cheque Table Receive', {\r\n    // Triggered when a new row is added\r\n    cheque_table_add: function(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n        \r\n        // Set default values for new row\r\n        if (!row.party_type) {\r\n            frappe.model.set_value(cdt, cdn, 'party_type', 'Customer');\r\n        }\r\n        \r\n        // Copy party details if party exists\r\n        if (row.party) {\r\n            set_party_details(frm, row);\r\n        }\r\n        \r\n        // Set default account if mode of payment exists\r\n        if (row.mode_of_payment) {\r\n            set_default_account(frm, row);\r\n        }\r\n    },\r\n    \r\n    // Triggered when mode of payment changes\r\n    mode_of_payment: function(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n        set_default_account(frm, row);\r\n    },\r\n    \r\n    // Triggered when party changes\r\n    party: function(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n        set_party_details(frm, row);\r\n    },\r\n    \r\n    // Triggered when account_paid_to changes\r\n    account_paid_to: function(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n        set_account_currency(frm, row, 'account_paid_to', 'account_currency');\r\n        update_exchange_rate(frm, row);\r\n    },\r\n    \r\n    // Triggered when account_paid_from changes\r\n    account_paid_from: function(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n        set_account_currency(frm, row, 'account_paid_from', 'account_currency_from');\r\n        update_exchange_rate(frm, row);\r\n    },\r\n    \r\n    // Triggered when reference_date changes\r\n    reference_date: function(frm, cdt, cdn) {\r\n        const row = locals[cdt][cdn];\r\n        update_exchange_rate(frm, row);\r\n    }\r\n});\r\n\r\n// Function to set party details in issuer_name and party_name\r\nfunction set_party_details(frm, row) {\r\n    if (!row.party || !row.party_type) return;\r\n    \r\n    frappe.call({\r\n        method: 'frappe.client.get_value',\r\n        args: {\r\n            doctype: row.party_type,\r\n            name: row.party,\r\n            fieldname: ['customer_name', 'supplier_name']\r\n        },\r\n        callback: function(r) {\r\n            if (r.message) {\r\n                const party_name = r.message.customer_name || r.message.supplier_name || row.party;\r\n                frappe.model.set_value(row.doctype, row.name, 'issuer_name', party_name);\r\n                frappe.model.set_value(row.doctype, row.name, 'party_name', party_name);\r\n                frm.refresh_field('cheque_table');\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// Function to set default account from mode of payment\r\nfunction set_default_account(frm, row) {\r\n    if (!row.mode_of_payment) return;\r\n    \r\n    frappe.call({\r\n        method: 'frappe.client.get',\r\n        args: {\r\n            doctype: 'Mode of Payment',\r\n            name: row.mode_of_payment\r\n        },\r\n        callback: function(r) {\r\n            if (r.message && r.message.accounts && r.message.accounts.length > 0) {\r\n                const default_account = r.message.accounts[0].default_account;\r\n                frappe.model.set_value(row.doctype, row.name, 'account_paid_to', default_account);\r\n                frm.refresh_field('cheque_table');\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// Function to set account currency based on account\r\nfunction set_account_currency(frm, row, account_field, currency_field) {\r\n    if (!row[account_field]) return;\r\n    \r\n    frappe.call({\r\n        method: 'frappe.client.get_value',\r\n        args: {\r\n            doctype: 'Account',\r\n            name: row[account_field],\r\n            fieldname: ['account_currency']\r\n        },\r\n        callback: function(r) {\r\n            if (r.message) {\r\n                frappe.model.set_value(row.doctype, row.name, currency_field, r.message.account_currency);\r\n                frm.refresh_field('cheque_table');\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\n// Function to update exchange rate\r\nfunction update_exchange_rate(frm, row) {\r\n    if (!row.account_paid_to || !row.account_paid_from || !row.reference_date) return;\r\n    \r\n    // Get currencies for both accounts\r\n    frappe.call({\r\n        method: 'frappe.client.get_value',\r\n        args: {\r\n            doctype: 'Account',\r\n            name: row.account_paid_to,\r\n            fieldname: ['account_currency']\r\n        },\r\n        callback: function(to_r) {\r\n            if (to_r.message) {\r\n                const to_currency = to_r.message.account_currency;\r\n                \r\n                frappe.call({\r\n                    method: 'frappe.client.get_value',\r\n                    args: {\r\n                        doctype: 'Account',\r\n                        name: row.account_paid_from,\r\n                        fieldname: ['account_currency']\r\n                    },\r\n                    callback: function(from_r) {\r\n                        if (from_r.message) {\r\n                            const from_currency = from_r.message.account_currency;\r\n                            \r\n                            // If currencies are different, get exchange rate\r\n                            if (to_currency !== from_currency) {\r\n                                frappe.call({\r\n                                    method: 'frappe.client.get_list',\r\n                                    args: {\r\n                                        doctype: 'Currency Exchange',\r\n                                        filters: {\r\n                                            from_currency: from_currency,\r\n                                            to_currency: to_currency,\r\n                                            date: ['<=', row.reference_date]\r\n                                        },\r\n                                        fields: ['exchange_rate'],\r\n                                        order_by: 'date desc',\r\n                                        limit: 1\r\n                                    },\r\n                                    callback: function(ex_r) {\r\n                                        if (ex_r.message && ex_r.message.length > 0) {\r\n                                            frappe.model.set_value(row.doctype, row.name, 'target_exchange_rate', ex_r.message[0].exchange_rate);\r\n                                        } else {\r\n                                            frappe.model.set_value(row.doctype, row.name, 'target_exchange_rate', 1);\r\n                                        }\r\n                                        frm.refresh_field('cheque_table');\r\n                                    }\r\n                                });\r\n                            } else {\r\n                                // Same currency, set exchange rate to 1\r\n                                frappe.model.set_value(row.doctype, row.name, 'target_exchange_rate', 1);\r\n                                frm.refresh_field('cheque_table');\r\n                            }\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    });\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Multiple Cheque Entry",
  "enabled": 1,
  "modified": "2025-12-24 19:14:36.487516",
  "module": "ECS Cheques",
  "name": "Cheque",
  "script": "frappe.ui.form.on('Multiple Cheque Entry', {\r\n    // لا نحتاج كتابة كود هنا حالياً، العمل كله على الـ Child Tables\r\n});\r\n\r\n// المنطق الخاص بجدول المقبوضات (cheque_table)\r\nfrappe.ui.form.on('Cheque Table Receive', {\r\n    cheque_table_add: function(frm, cdt, cdn) {\r\n        copy_previous_row(frm, cdt, cdn, 'cheque_table', [\r\n            'mode_of_payment', 'party', 'bank', 'reference_no', 'reference_date',\r\n            'cheque_type', 'paid_amount', 'first_beneficiary', 'issuer_name',\r\n            'payment_entry', 'person_name', 'party_type', 'account_paid_to',\r\n            'account_currency', 'account_paid_from', 'account_currency_from',\r\n            'picture_of_check', 'target_exchange_rate', 'party_name'\r\n        ]);\r\n    }\r\n});\r\n\r\n// المنطق الخاص بجدول المدفوعات (cheque_table_2)\r\nfrappe.ui.form.on('Cheque Table Pay', {\r\n    cheque_table_2_add: function(frm, cdt, cdn) {\r\n        copy_previous_row(frm, cdt, cdn, 'cheque_table_2', [\r\n            'mode_of_payment', 'party', 'account_paid_from', 'account_paid_to',\r\n            'reference_no', 'reference_date', 'paid_amount', 'cheque_type',\r\n            'first_beneficiary', 'person_name', 'issuer_name', 'picture_of_check',\r\n            'account_currency_from', 'party_type', 'account_currency', 'target_exchange_rate'\r\n        ]);\r\n    }\r\n});\r\n\r\n// دالة مساعدة لعمل النسخ (لتجنب تكرار الكود)\r\nvar copy_previous_row = function(frm, cdt, cdn, table_fieldname, fields) {\r\n    let row = locals[cdt][cdn];\r\n    let grid = frm.fields_dict[table_fieldname].grid;\r\n    let row_index = row.idx;\r\n\r\n    // التأكد أن هناك سطر سابق (يعني هذا السطر رقم 2 أو أكثر)\r\n    if (row_index > 1) {\r\n        // الحصول على بيانات السطر السابق (idx - 2 لأن المصفوفة تبدأ من 0)\r\n        let prev_row = grid.grid_rows[row_index - 2].doc;\r\n\r\n        fields.forEach(field => {\r\n            if (prev_row[field]) {\r\n                frappe.model.set_value(cdt, cdn, field, prev_row[field]);\r\n            }\r\n        });\r\n        \r\n        frm.refresh_field(table_fieldname);\r\n    }\r\n};",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payment Entry",
  "enabled": 1,
  "modified": "2026-01-15 10:13:12.433333",
  "module": "ECS Cheques",
  "name": "Payment Entry List",
  "script": "frappe.listview_settings['Payment Entry'] = {\r\n    refresh: function(listview) {\r\n        // إضافة الزر المخصص بتنسيق احترافي\r\n        let button = listview.page.add_inner_button(__('Action Full Update'), function() {\r\n            let selected_docs = listview.get_checked_items();\r\n            \r\n            if (selected_docs.length === 0) {\r\n                frappe.msgprint({\r\n                    title: __('تنبيه'),\r\n                    indicator: 'orange',\r\n                    message: __('يرجى تحديد حركات الدفع التي تريد تحديثها أولاً.')\r\n                });\r\n                return;\r\n            }\r\n\r\n            // استدعاء النافذة المنبثقة\r\n            show_bulk_update_dialog(selected_docs, listview);\r\n        });\r\n\r\n        // تنسيق الزر (رمادي، حواف حمراء، خط أبيض بولد)\r\n        $(button).css({\r\n            'background-color': '#6c757d', \r\n            'color': 'white',             \r\n            'font-weight': 'bold',        \r\n            'border': '2px solid #dc3545', \r\n            'border-radius': '8px',\r\n            'padding': '5px 15px'\r\n        });\r\n    }\r\n};\r\n\r\nfunction show_bulk_update_dialog(selected_docs, listview) {\r\n    // جلب خيارات الإجراءات ديناميكياً\r\n    let field_meta = frappe.get_meta('Payment Entry').fields.find(f => f.fieldname === 'cheque_action');\r\n    let dynamic_options = field_meta ? field_meta.options : \"\";\r\n\r\n    let d = new frappe.ui.Dialog({\r\n        title: __('تحديث بيانات الشيكات المحددة'),\r\n        fields: [\r\n            {\r\n                label: __('Bank'),\r\n                fieldname: 'cheque_bank',\r\n                fieldtype: 'Link',\r\n                options: 'Bank'\r\n            },\r\n            {\r\n                label: __('Bank Account'),\r\n                fieldname: 'bank_acc',\r\n                fieldtype: 'Link',\r\n                options: 'Bank Account'\r\n            },\r\n            {\r\n                fieldtype: 'Column Break'\r\n            },\r\n            {\r\n                label: __('Cheque Action Date'),\r\n                fieldname: 'cheque_action_date',\r\n                fieldtype: 'Date'\r\n            },\r\n            {\r\n                label: __('Cheque Action'),\r\n                fieldname: 'cheque_action',\r\n                fieldtype: 'Select',\r\n                options: dynamic_options\r\n            },\r\n            {\r\n                fieldtype: 'Section Break'\r\n            },\r\n            // النص الإرشادي الأول\r\n            {\r\n                fieldtype: 'HTML',\r\n                options: `<div style=\"font-weight: bold; color: #d9534f; margin-bottom: 10px;\">\r\n                            ${__('مهم عند اختيار \"تحويل إلى حافظة شيكات أخرى\" تحديد الحقول الاتية')}\r\n                          </div>`\r\n            },\r\n            {\r\n                label: __('New Mode of Payment'),\r\n                fieldname: 'new_mode_of_payment',\r\n                fieldtype: 'Link',\r\n                options: 'Mode of Payment',\r\n                get_query: function() {\r\n                    return {\r\n                        filters: { 'type': 'Cheque' }\r\n                    };\r\n                }\r\n            },\r\n            {\r\n                fieldtype: 'Section Break'\r\n            },\r\n            // النص الإرشادي الثاني\r\n            {\r\n                fieldtype: 'HTML',\r\n                options: `<div style=\"font-weight: bold; color: #d9534f; margin-bottom: 10px;\">\r\n                            ${__('مهم عند اختيار \"تظهير شيك\" تحديد الحقول الاتية')}\r\n                          </div>`\r\n            },\r\n            {\r\n                label: __('Endorsed Party Type'),\r\n                fieldname: 'party_type_',\r\n                fieldtype: 'Link',\r\n                options: 'DocType'\r\n            },\r\n            {\r\n                label: __('Endorsed Party Name'),\r\n                fieldname: 'party_',\r\n                fieldtype: 'Dynamic Link',\r\n                options: 'party_type_'\r\n            },\r\n            {\r\n                label: __('Endorsed Party Account'),\r\n                fieldname: 'account_1',\r\n                fieldtype: 'Link',\r\n                options: 'Account'\r\n            }\r\n        ],\r\n        primary_action_label: __('Update Now'),\r\n        primary_action(values) {\r\n            d.hide();\r\n            process_updates(selected_docs, values, listview);\r\n        }\r\n    });\r\n\r\n    d.show();\r\n}\r\n\r\nasync function process_updates(docs, values, listview) {\r\n    frappe.show_progress(__('جاري تحديث الحركات'), 0, docs.length, __('يرجى الانتظار...'));\r\n\r\n    for (let i = 0; i < docs.length; i++) {\r\n        let doc = docs[i];\r\n        \r\n        let update_data = {};\r\n        \r\n        // الحقول الأساسية\r\n        if (values.cheque_bank) update_data.cheque_bank = values.cheque_bank;\r\n        if (values.bank_acc) update_data.bank_acc = values.bank_acc;\r\n        if (values.cheque_action_date) update_data.cheque_action_date = values.cheque_action_date;\r\n        if (values.cheque_action) update_data.cheque_action = values.cheque_action;\r\n        \r\n        // حقول الحافظة والتظهير (تُحدث إذا تم تعبئتها في الدايلوج)\r\n        if (values.new_mode_of_payment) update_data.new_mode_of_payment = values.new_mode_of_payment;\r\n        if (values.party_type_) update_data.party_type_ = values.party_type_;\r\n        if (values.party_) update_data.party_ = values.party_;\r\n        if (values.account_1) update_data.account_1 = values.account_1;\r\n\r\n        if (Object.keys(update_data).length > 0) {\r\n            try {\r\n                await frappe.db.set_value('Payment Entry', doc.name, update_data);\r\n            } catch (e) {\r\n                console.error(`Error updating ${doc.name}: `, e);\r\n            }\r\n        }\r\n\r\n        frappe.show_progress(__('جاري تحديث الحركات'), i + 1, docs.length);\r\n    }\r\n\r\n    frappe.hide_progress();\r\n    frappe.show_alert({message: __('تم تحديث جميع الحركات المختارة بنجاح'), indicator: 'green'});\r\n    listview.refresh();\r\n}",
  "view": "List"
 }
]